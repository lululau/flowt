# 自动日志刷新功能实现

## 功能概述

实现了在创建流水线运行后自动显示日志并每 5 秒刷新一次的功能。该功能提供了实时的流水线执行状态监控，让用户能够及时了解流水线的执行进度。

## 实现的功能

### 1. 自动日志显示
- 创建流水线运行后，自动切换到日志视图
- 显示流水线基本信息（名称、运行ID、分支、仓库等）
- 实时显示流水线执行状态和日志内容

### 2. 自动刷新机制
- **刷新频率**: 每 5 秒自动刷新一次
- **智能停止**: 流水线完成后（SUCCESS/FAILED/CANCELED）自动停止刷新
- **手动停止**: 用户离开日志视图时自动停止刷新

### 3. 状态监控
- 实时显示流水线状态（RUNNING、SUCCESS、FAILED等）
- 显示开始时间和结束时间
- 显示最后更新时间戳

## 新增的函数

### `startLogAutoRefresh()`
```go
func startLogAutoRefresh(app *tview.Application, apiClient *api.Client, orgId, pipelineName, branchInfo, repoInfo string)
```
- **功能**: 启动自动日志刷新机制
- **参数**: 应用实例、API客户端、组织ID、流水线名称、分支信息、仓库信息
- **特性**: 
  - 使用 `time.Ticker` 每 5 秒触发一次刷新
  - 检查 `isLogViewActive` 状态，只在日志视图激活时刷新
  - 自动停止机制，避免资源泄漏

### `stopLogAutoRefresh()`
```go
func stopLogAutoRefresh()
```
- **功能**: 停止自动日志刷新
- **调用时机**: 
  - 用户离开日志视图（按 'q'、'b' 或 Escape）
  - 流水线执行完成
  - 启动新的刷新任务前

### `fetchAndDisplayLogs()`
```go
func fetchAndDisplayLogs(app *tview.Application, apiClient *api.Client, orgId, pipelineName, branchInfo, repoInfo string)
```
- **功能**: 获取并显示当前日志
- **显示内容**:
  - 流水线基本信息头部
  - 实时状态和时间信息
  - 完整的日志内容
  - 最后更新时间戳
  - 操作提示信息

## 修改的现有功能

### `runPipelineWithBranch()` 函数
- **修改**: 替换了原有的一次性日志获取逻辑
- **新逻辑**: 调用 `startLogAutoRefresh()` 启动自动刷新
- **优势**: 提供持续的日志监控而不是静态显示

### 日志视图事件处理
- **增强**: 在退出日志视图时调用 `stopLogAutoRefresh()`
- **目的**: 确保资源正确释放，避免后台持续刷新

### 运行历史日志查看
- **智能刷新**: 
  - 对于正在运行的流水线：启动自动刷新
  - 对于已完成的流水线：只获取一次日志
- **用户体验**: 根据流水线状态提供不同的日志查看体验

## 全局变量

```go
var (
    logRefreshTicker *time.Ticker  // 定时器
    logRefreshStop   chan bool     // 停止信号通道
)
```

## 使用场景

### 1. 新建流水线运行
1. 用户触发流水线运行
2. 系统自动切换到日志视图
3. 开始每 5 秒自动刷新日志
4. 流水线完成后自动停止刷新

### 2. 查看历史运行日志
1. 用户从运行历史选择一个运行记录
2. 系统检查运行状态：
   - 如果仍在运行：启动自动刷新
   - 如果已完成：只显示一次日志

### 3. 手动停止
- 用户按 'q'、'b' 或 Escape 键离开日志视图
- 系统自动停止后台刷新任务

## 技术特性

### 1. 资源管理
- 使用 `time.Ticker` 进行定时任务
- 通过 channel 进行优雅的停止控制
- 避免 goroutine 泄漏

### 2. 状态检查
- 检查 `isLogViewActive` 确保只在需要时刷新
- 检查流水线状态，完成后自动停止

### 3. 用户体验
- 显示最后更新时间，让用户知道日志是实时的
- 提供清晰的状态信息和操作提示
- 智能的刷新策略，避免不必要的API调用

## 错误处理

- API调用失败时显示错误信息
- 避免重复显示相同的错误信息
- 提供用户友好的错误提示

## 性能考虑

- 只在日志视图激活时进行刷新
- 完成的流水线不进行无意义的刷新
- 用户离开时立即停止后台任务
- 使用高效的字符串构建方式

这个实现提供了一个完整的实时日志监控解决方案，大大提升了用户在使用流水线时的体验。 