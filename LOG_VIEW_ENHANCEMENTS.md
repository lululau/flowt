# 日志界面增强功能

## 概述

为 flowt 的日志界面添加了三个重要的增强功能，提升用户体验和操作便利性。

## 新增功能

### 1. 手动刷新功能

**按键**: `r`

**功能描述**:
- 在日志界面按 `r` 键可以立即手动刷新日志内容
- 不影响自动刷新的正常运行
- 适用于用户想要立即查看最新日志的场景

**使用场景**:
- 等待关键日志输出时，不想等待下一次自动刷新
- 在网络延迟较高时，主动触发刷新
- 调试时需要频繁查看日志更新

### 2. 延迟停止自动刷新

**功能描述**:
- 当流水线运行状态变为完成（SUCCESS/FAILED/CANCELED）时，自动刷新不会立即停止
- 而是继续刷新 3 次（每次间隔 5 秒），然后才停止自动刷新
- 确保用户能看到完整的最终日志和状态信息

**实现逻辑**:
1. 检测到流水线完成状态时，标记 `pipelineFinished = true`
2. 继续自动刷新，每次刷新时 `finishedRefreshCount++`
3. 当 `finishedRefreshCount >= 3` 时，停止自动刷新

**用户体验**:
- 避免在流水线刚完成时错过最后的日志输出
- 给系统时间来完成所有日志的写入和同步
- 用户无需手动刷新来查看完整的最终状态

### 3. 状态栏显示

**位置**: 日志界面底部

**显示内容**:
- 当前运行状态（RUNNING/SUCCESS/FAILED/CANCELED）
- 自动刷新状态（ON/OFF/剩余次数）

**状态颜色**:
- **RUNNING**: 绿色文字
- **SUCCESS**: 白色文字  
- **FAILED**: 红色文字
- **CANCELED**: 灰色文字

**状态栏示例**:
```
Status: [green]RUNNING[-] | Auto-refresh: ON
Status: [white]SUCCESS[-] | Auto-refresh: ON (2 more)
Status: [red]FAILED[-] | Auto-refresh: OFF
```

## 技术实现

### 新增全局变量

```go
// 状态跟踪
currentRunStatus        string             // 当前运行状态
logStatusBar            *tview.TextView    // 状态栏组件

// 延迟停止控制
finishedRefreshCount int  // 完成后的刷新次数
pipelineFinished     bool // 流水线是否已完成
```

### 核心函数

#### `updateLogStatusBar()`
- 根据当前运行状态更新状态栏显示
- 使用 tview 的颜色标记语法
- 显示自动刷新的当前状态

#### `getAutoRefreshStatus()`
- 返回自动刷新状态的文本描述
- 在延迟停止期间显示剩余刷新次数

#### 修改的 `fetchAndDisplayLogs()`
- 从日志内容中提取运行状态
- 实现延迟停止逻辑
- 更新状态栏显示
- 更新帮助文本包含手动刷新说明

### 界面布局修改

**原布局**:
```
┌─────────────────────────┐
│       Log Content       │
│                         │
│                         │
└─────────────────────────┘
```

**新布局**:
```
┌─────────────────────────┐
│       Log Content       │
│                         │
│                         │
├─────────────────────────┤
│ Status: RUNNING | Auto  │
└─────────────────────────┘
```

## 用户界面更新

### 帮助文本更新

**原文本**:
```
Auto-refreshing every 5 seconds. Press 'q' to return, 'e' to edit in editor, 'v' to view in pager.
```

**新文本**:
```
Auto-refreshing every 5 seconds. Press 'r' to refresh manually, 'q' to return, 'e' to edit in editor, 'v' to view in pager.
```

### 按键绑定

| 按键 | 功能 |
|------|------|
| `r` | 手动刷新日志 |
| `e` | 在编辑器中打开日志 |
| `v` | 在分页器中查看日志 |
| `q` | 返回上一界面 |

## 使用流程

### 新建流水线运行
1. 创建运行后进入日志界面
2. 状态栏显示 "Status: [green]RUNNING[-] | Auto-refresh: ON"
3. 每 5 秒自动刷新日志内容
4. 可随时按 `r` 手动刷新

### 流水线完成
1. 检测到完成状态（SUCCESS/FAILED/CANCELED）
2. 状态栏更新为相应颜色和状态
3. 显示 "Auto-refresh: ON (3 more)" → "ON (2 more)" → "ON (1 more)" → "OFF"
4. 3 次额外刷新后自动停止

### 历史运行查看
1. 从运行历史进入日志界面
2. 根据历史运行状态初始化状态栏
3. 已完成的运行通常只刷新一次
4. 仍在运行的历史记录会启动自动刷新

## 兼容性

- 完全向后兼容现有功能
- 不影响编辑器和分页器功能
- 保持原有的键盘快捷键
- 状态栏不占用焦点，不影响导航

## 测试建议

1. **手动刷新测试**:
   - 在日志界面按 `r` 键
   - 验证日志内容立即更新
   - 确认不影响自动刷新计时

2. **延迟停止测试**:
   - 观察流水线从运行到完成的过程
   - 验证完成后继续刷新 3 次
   - 确认最终停止自动刷新

3. **状态栏测试**:
   - 验证不同状态的颜色显示
   - 检查自动刷新状态的准确性
   - 确认状态栏不影响日志滚动

4. **界面导航测试**:
   - 确认状态栏不获得焦点
   - 验证所有原有快捷键正常工作
   - 测试在不同界面间切换的状态保持

## 总结

这些增强功能显著提升了日志界面的用户体验：

- **手动刷新**: 提供了更多的用户控制权
- **延迟停止**: 确保不错过重要的最终日志
- **状态栏**: 提供清晰的状态反馈和自动刷新信息

所有功能都经过精心设计，确保与现有功能完美集成，不影响用户的现有工作流程。 